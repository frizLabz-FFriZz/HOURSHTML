<!DOCTYPE html>
<html lang="en">
  <head <meta charset="UTF-8">
    <title>Job Hours Tracker</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600&amp;display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Roboto", sans-serif;
        background: url("https://i.ibb.co/HDpk79fG/20250802-2351-Blueprint-Design-Focus-remix-01k1q45dyyeraatt9ae1cgfbmp.png")
          no-repeat center center fixed;
        background-size: cover;
        padding: 2vw 10vw;
      }

      h1,
      h3 {
        text-align: center;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
      }

      .text-left {
        text-align: left;
      }

      .header-center {
        display: flex;
        gap: 10px;
      }

      select.pay-period-select {
        padding: 3px 6px;
        font-size: 16px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }

      .day-table {
        table-layout: fixed;
        width: 100%;
      }

      .day-table th,
      .day-table td {
        padding: 3px 6px;
        text-align: center;
        box-sizing: border-box;
      }

      /* Set percent widths for columns */
      .day-table th:first-child,
      .day-table td:first-child {
        /* Job */
        width: 20%;
        min-width: 120px;
        text-align: left;
        word-break: break-word;
        white-space: normal;
      }

      .day-table th:nth-child(2),
      .day-table td:nth-child(2) {
        /* Hours */
        width: 10%;
        min-width: 70px;
        text-align: center;
      }

      .day-table th:nth-child(3),
      .day-table td:nth-child(3) {
        /* Address */
        width: 30%;
        min-width: 120px;
        text-align: center;
        word-break: break-word;
        white-space: normal;
      }

      .day-table th:nth-child(4),
      .day-table td:nth-child(4) {
        /* Description */
        width: 17.5%;
        min-width: 120px;
        text-align: center;
        word-break: break-word;
        white-space: normal;
      }

      .day-table th:nth-child(5),
      .day-table td:nth-child(5) {
        /* Images */
        width: 17.5%;
        min-width: 70px;
        text-align: center;
      }

      .day-table th:nth-child(6),
      .day-table td:nth-child(6) {
        /* Actions */
        width: 6%;
        min-width: 70px;
        text-align: center;
      }

      .day-table td:first-child {
        text-align: left;
        /* Align job names to the left */
        padding-right: 0;
        /* Remove extra padding on the right */
      }

      .day-table tr:nth-child(even) {
        background: #e9e9e9;
      }

      .day-table tr:nth-child(odd) {
        background: none;
      }

      .day-total {
        font-weight: bold;
        background: #6f7677;
        color: #fff;
      }

      .day-header {
        text-align: left;
        font-weight: bold;
        color: #fff;
        background: none;
      }

      .day-header-row {
        font-weight: bold;
        color: #000;
      }

      .summary-header-row {
        background: #6f7677;
        font-weight: bold;
        color: #fff;
      }

      .day-job-even {
        background: #e9e9e9;
      }

      .day-job-odd {
        background: #ffffff;
      }

      .btn {
        padding: 5px 10px;
        border: none;
        cursor: pointer;
        border-radius: 4px;
        font-size: 14px;
      }

      .margin-bottom {
        margin-bottom: 20px;
      }

      .btn-add {
        background: #4caf50;
        color: #fff;
      }

      .btn-check {
        background: #2196f3;
        color: #fff;
      }

      .btn-edit {
        background: #ff9800;
        color: #fff;
      }

      .btn-delete {
        background: #f44336;
        color: #fff;
      }

      .totals {
        font-weight: bold;
        background: #fafafa;
        padding: 10px;
        text-align: center;
      }

      #logPanel,
      #metaPanel {
        display: none;
        background: #222;
        color: #0f0;
        padding: 10px;
        height: 200px;
        overflow: auto;
        font-family: monospace;
        font-size: 12px;
        margin-top: 20px;
      }

      .logo-container {
        display: flex;
        justify-content: center;
        margin-bottom: 2%;
      }

      .logo-container img {
        max-width: 300px;
        width: 100%;
        height: auto;
      }

      .days-manager-dropdown {
        display: none;
        left: 0;
        top: 0;
        background: #fff;
        border: 1px solid #ccc;
        z-index: 1000;
        padding: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .days-manager-label {
        display: block;
        flex-direction: column;
        background: #fff;
        padding: 7px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        /* Ensure it appears above other elements */
        top: 100%;
        /* Position it below the trigger button */
        left: 0;
        /* Align it to the left of the parent */
      }

      #periodDropdown {
        display: none;
        margin-bottom: 25px;
        border: 1px solid #ccc;
        background-color: #f9f9f9;
      }

      .full-width-input {
        width: 90%;
        box-sizing: border-box;
        padding: 3px 6px;
        font-size: 15px;
        border: 1px solid #ccc;
        border-radius: 3px;
        background: #fff;
      }

      /* Login section styles */
      #loginSection {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        color: #fff;
      }

      #loginSection h1 {
        margin-bottom: 20px;
      }

      #loginSection input {
        margin-bottom: 10px;
        padding: 10px;
        width: 300px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.8);
      }

      #loginSection button {
        margin-bottom: 10px;
        padding: 10px;
        width: 320px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }

      #loginSection #loginButton {
        background: #2196f3;
        color: #fff;
      }

      #loginSection #createAccountButton {
        background: #4caf50;
        color: #fff;
      }

      #loginSection #loginError {
        color: red;
        margin-top: 10px;
      }
    </style>
  </head>

  <body>
    <div class="logo-container">
      <a href="https://ibb.co/NgFdFnhr"
        ><img
          src="https://i.ibb.co/HLKfKpvC/DDFGTDGDsdfsdf-G.png"
          alt="Easton Construction Logo"
          border="0"
      /></a>
    </div>
    <div class="header">
      <div class="header-left">
        <button class="btn btn-edit" id="daysManagerBtn" type="button">
          Days Worked Manager
        </button>
        <div id="daysManagerDropdown" class="days-manager-dropdown"></div>
      </div>
      <div class="header-center">
        <select id="payPeriodSelect" class="pay-period-select"></select>
        <button class="btn btn-edit" id="editPeriodBtn">Edit Period</button>
        <button class="btn btn-add" id="addPeriodBtn">Add Period</button>
      </div>
    </div>

    <div
      id="dateEditContainer"
      style="display: none; margin-top: 10px; gap: 10px; flex-direction: column"
    >
      <div style="display: flex; gap: 10px">
        <input type="date" id="startDateInput" style="flex: 1" />
        <input type="date" id="endDateInput" style="flex: 1" />
      </div>
      <div style="display: flex; gap: 10px; width: 100%">
        <button class="btn btn-check half-btn margin-bottom" id="savePeriodBtn">
          Save Period
        </button>
        <button class="btn btn-view half-btn margin-bottom" id="viewPeriodsBtn">
          View Periods
        </button>
      </div>
      <div
        id="periodDropdown"
        style="
          display: none;
          margin-top: 3px;
          border: 1px solid #ccc;
          padding: 10px;
          background-color: #f9f9f9;
        "
      >
        <p
          style="
            font-style: italic;
            color: #777;
            margin-top: 0;
            margin-bottom: 8px;
          "
        ></p>
      </div>
    </div>

    <div id="dayTables"></div>

    <div id="jobSummary"></div>

    <br />
    <div class="action-row">
      <button class="btn btn-add" id="generateInvoice">Generate Invoice</button>
      <button class="btn btn-logs" id="toggleLogs">Show Logs</button>
      <button class="btn btn-meta" id="toggleMeta">Show Meta Data</button>
    </div>

    <div id="logPanel"></div>
    <div id="metaPanel"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>

      const mapping_bin_id = "68902294f7e7a370d1f333e8"
        let bin_id = ""
        ;


    const JSONBIN_KEY = "$2a$10$aSeeuCiSQD9XH5npv2KfJOxBD/tRZYF.yGmd3sMxxxDYywj/ua8Da";

        
     async function generateBinId(firstName, lastName, pin) {
        const binName = `${firstName}_${lastName}`;
        try {
          // Log the request details for debugging
          console.log("Creating bin with the following details:", {
            url: "https://api.jsonbin.io/v3/b",
            headers: {
              "Content-Type": "application/json",
              "X-Master-Key": JSONBIN_KEY,
              "X-Bin-Name": binName,
              "X-Bin-Private": "false",
            },
            body: {},
          });

          // Step 1: Create a new bin
          const response = await fetch("https://api.jsonbin.io/v3/b", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Master-Key": JSONBIN_KEY,
              "X-Bin-Name": binName,
              "X-Bin-Private": "false",
            },
            body: JSON.stringify({}), // Empty JSON object for the new bin
          });

          if (!response.ok) {
            const errorDetails = await response.json();
            console.error("Error response from API:", errorDetails);
            throw new Error(`Failed to create bin: ${response.statusText}`);
          }

          const data = await response.json();
          const binId = data.metadata.id;

          // Step 2: Update mappings with the new bin_id
          const fullName = `${firstName} ${lastName}`;
          if (!state.mappings) state.mappings = {};
          state.mappings[fullName] = { pin: pin, bin_id: binId };

          // Step 3: Save updated mappings to JSONBin
          await saveData(mapping_bin_id);

          // Step 4: Fetch the user's JSON data using the new bin_id
          await fetchData(binId);

          bin_id = binId; // Store the bin_id for later use

          return binId;
        } catch (error) {
          console.error("Error generating bin ID:", error);
          alert("Failed to create a new bin. Please try again.");
          throw error;
        }
      }

      function getJSONBIN_URL(id) {
        const urlString = "https://api.jsonbin.io/v3/b/" + id;
      }
    
      

      let state = { payPeriods: {}, Job_Meta: {} };
      let currentPeriod = "";
      let currentUser = ""; // Track the logged-in user

      function logMessage(msg, isError = false) {
        const panel = document.getElementById("logPanel");
        const line = document.createElement("div");
        line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        line.style.color = isError ? "red" : "#0f0";
        panel.appendChild(line);
        panel.scrollTop = panel.scrollHeight;
      }

      async function fetchData(bin_id) {
        try {
          const res = await fetch(getJSONBIN_URL(bin_id), {
            headers: { "X-Master-Key": JSONBIN_KEY },
          });
          const data = await res.json();
          state = data.record || { payPeriods: {}, Job_Meta: {} };
          if (!state.Job_Meta) state.Job_Meta = {};
          logMessage("Data loaded successfully.");
        } catch (e) {
          logMessage("Error loading data: " + e.message, true);
        }
      }

      async function saveData(bin_id) {
        try {
          if (!bin_id) {
            console.error("saveData called with undefined bin_id");
            throw new Error("bin_id is required to save data");
          }

          const url = getJSONBIN_URL(bin_id);
          console.log(`Saving data to URL: ${url} with PUT method`);

          await fetch(url, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "X-Master-Key": JSONBIN_KEY,
            },
            body: JSON.stringify(state),
          });

          logMessage("Changes saved to JSONBin.");
          refreshMetaPanel();
        } catch (e) {
          logMessage("Error saving data: " + e.message, true);
          throw e;
        }
      }

      // Helpers to handle dates in local timezone to avoid off-by-one issues
      function toLocalISO(date) {
        const offset = date.getTimezoneOffset();
        const local = new Date(date.getTime() - offset * 60000);
        return local.toISOString().split("T")[0];
      }

      function parseLocal(dateStr) {
        return new Date(`${dateStr}T00:00:00`);
      }

      function formatDate(dateStr) {
        // Format the date to 'Tue Jul 29 2025' style
        return parseLocal(dateStr).toDateString();
      }

      function formatPeriod(start, end) {
        // Format the start and end dates to 'Tue Jul 29 2025' style
        const s = parseLocal(start).toDateString();
        const e = parseLocal(end).toDateString();
        return `${s} - ${e}`;
      }

      function getCurrentPeriodRange(date = new Date()) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day < 3 ? -4 : 3);
        const start = new Date(d.setDate(diff));
        const end = new Date(start);
        end.setDate(start.getDate() + 13);
        return [toLocalISO(start), toLocalISO(end)];
      }

      // preserve unlocked input values
      function captureInputs() {
        const inputs = {};
        document.querySelectorAll("tr").forEach((row) => {
          row.querySelectorAll("input, select").forEach((input) => {
            inputs[input.id] = input.value;
          });
        });
        return inputs;
      }

      function restoreInputs(saved) {
        for (const id in saved) {
          const el = document.getElementById(id);
          if (el) el.value = saved[id];
        }
      }

      function getPayPeriodDates(periodKey) {
        const [start, end] = periodKey.split("_to_");
        const dates = [];
        let d = parseLocal(start);
        const endDate = parseLocal(end);
        while (d <= endDate) {
          dates.push(toLocalISO(d));
          d.setDate(d.getDate() + 1);
        }
        return dates;
      }

      function ensureDaysWorkedArray(periodKey) {
        let period = state.payPeriods[periodKey];
        if (!period.daysWorked) {
          // create array: all non-weekend dates in period
          period.daysWorked = getPayPeriodDates(periodKey).filter((dateStr) => {
            const day = parseLocal(dateStr).getDay();
            return day !== 0 && day !== 6; // Not Sunday or Saturday
          });
          saveData(); // persist this
        }
      }

      function handleImageUpload(date, idx, event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const base64Image = e.target.result;
            if (!state.payPeriods[currentPeriod].jobs[date][idx].images) {
              state.payPeriods[currentPeriod].jobs[date][idx].images = [];
            }
            state.payPeriods[currentPeriod].jobs[date][idx].images.push(
              base64Image
            );
            saveData().then(render);
          };
          reader.readAsDataURL(file);
        }
      }

      function openImageViewer(images, startIndex) {
        let currentIndex = startIndex;

        const viewer = document.createElement("div");
        viewer.style.position = "fixed";
        viewer.style.top = "0";
        viewer.style.left = "0";
        viewer.style.width = "100vw";
        viewer.style.height = "100vh";
        viewer.style.backgroundColor = "rgba(0, 0, 0, 0.8)";
        viewer.style.display = "flex";
        viewer.style.justifyContent = "center";
        viewer.style.alignItems = "center";
        viewer.style.zIndex = "1000";

        const img = document.createElement("img");
        img.src = images[currentIndex];
        img.style.maxWidth = "90%";
        img.style.maxHeight = "90%";
        viewer.appendChild(img);

        viewer.onclick = () => {
          document.body.removeChild(viewer);
        };

        document.body.appendChild(viewer);
      }

      // Added login and account creation functionality
      // Hide all content initially and show login section
      window.addEventListener("DOMContentLoaded", () => {
        document.body.innerHTML = `
        <div id="loginSection" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;">
            <h1>Login</h1>
            <div style="display: flex; flex-direction: row; gap: 10px;">
                <input type="text" id="loginFirstName" placeholder="First Name" style="margin-bottom: 10px; width: 100px;">
                <input type="text" id="loginLastName" placeholder="Last Name" style="margin-bottom: 10px; width: 100px">
            </div>
            <input type="password" id="loginPin" placeholder="Pin #" style="margin-bottom: 10px; width: 230px;">
            <button id="loginButton" style="margin-bottom: 10px; width: 250px;">Login</button>
            <button id="createAccountButton" style="margin-bottom: 10px; width: 250px;">Create Account</button>
        </div>
        <div id="mainContent" style="display: none;">
            ${document.body.innerHTML}
        </div>
    `;

        document.getElementById("loginButton").addEventListener("click", handleLogin);
        document.getElementById("createAccountButton").addEventListener("click", showCreateAccountForm);
      });

      function showCreateAccountForm() {
        const loginSection = document.getElementById("loginSection");
        loginSection.innerHTML = `
        <h1>Create Account</h1>
        <input type="text" id="firstName" placeholder="First Name" style="margin-bottom: 10px; padding: 5px;">
        <input type="text" id="lastName" placeholder="Last Name" style="margin-bottom: 10px; padding: 5px;">
        <input type="password" id="password" placeholder="Pin" style="margin-bottom: 10px; padding: 5px;">
        <input type="password" id="rePassword" placeholder="Re-enter Pin" style="margin-bottom: 10px; padding: 5px;">
        <button id="createAccountSubmit">Submit</button>
        <button id="backToLogin">Back</button>
    `;

        document.getElementById("createAccountSubmit").addEventListener("click", handleCreateAccount);
        document.getElementById("backToLogin").addEventListener("click", () => location.reload());
      }

      async function handleCreateAccount() {
        const firstName = document.getElementById("firstName").value.trim();
        const lastName = document.getElementById("lastName").value.trim();
        const fullName = `${firstName} ${lastName}`;
        const pin = document.getElementById("password").value;
        const rePin = document.getElementById("rePassword").value;

        if (!firstName || !lastName || !pin || !rePin) {
          alert("All fields are required.");
          return;
        }

        if (pin !== rePin) {
          alert("Pins do not match.");
          return;
        }

        if (!state.mappings) state.mappings = {};
        if (state.mappings[fullName]) {
          alert("Account already exists.");
          return;
        }

        try {
          const binId = await generateBinId(firstName, lastName, pin);
          state.mappings[fullName] = { pin: pin, bin_id: binId };
          await saveData(mapping_bin_id);
          location.reload();
        } catch (error) {
          console.error("Error creating account:", error);
          alert("Failed to create account. Please try again.");
        }
      }

      function handleLogin() {
        const firstName = document.getElementById("loginFirstName").value.trim();
        const lastName = document.getElementById("loginLastName").value.trim();
        const pin = document.getElementById("loginPin").value;

        const fullName = `${firstName} ${lastName}`;

        if (!state.mappings || !state.mappings[fullName] || state.mappings[fullName].pin !== pin) {
          alert("Invalid credentials.");
          return;
        }

        alert(`Welcome, ${fullName}!`);
        currentUser = fullName;
        bin_id = state.mappings[fullName].bin_id;

        document.getElementById("loginSection").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        render();
      }

      // Modify render to only show the logged-in user's data
      function render() {
        if (!currentUser) return;

        const userData = state.users[currentUser]?.data || {};
        state.payPeriods = userData.payPeriods || {};
        state.Job_Meta = userData.Job_Meta || {};

        const savedInputs = captureInputs();
        const container = document.getElementById("dayTables");
        container.innerHTML = "";
        let grandTotal = 0;

        if (!window.daysManagerVisibility) window.daysManagerVisibility = {};
        ensureDaysWorkedArray(currentPeriod);
        let period = state.payPeriods[currentPeriod];
        let jobs = period?.jobs || {};
        let allDates = getPayPeriodDates(currentPeriod);
        let daysWorked = period.daysWorked || [];

        // --- Days Worked Manager dropdown ---
        const dropdown = document.getElementById("daysManagerDropdown");
        dropdown.innerHTML = "";
        allDates.forEach((date) => {
          const dayObj = parseLocal(date);
          const isWeekend = dayObj.getDay() === 0 || dayObj.getDay() === 6;
          const hasData = jobs[date] && jobs[date].length > 0;
          const label = document.createElement("label");
          label.className = "days-manager-label";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = daysWorked.includes(date);
          cb.onchange = () => {
            if (cb.checked) {
              if (!daysWorked.includes(date)) daysWorked.push(date);
            } else {
              daysWorked = daysWorked.filter((d) => d !== date);
            }
            // sort daysWorked to match pay period date order
            period.daysWorked = allDates.filter((d) => daysWorked.includes(d));
            saveData().then(render);
          };
          label.appendChild(cb);
          label.appendChild(
            document.createTextNode(" " + dayObj.toDateString())
          );
          dropdown.appendChild(label);
        });

        // --- Only show tables for days in daysWorked ---
        daysWorked.forEach((date) => {
          let dailyTotal = 0;
          if (jobs[date]) jobs[date].forEach((j) => (dailyTotal += j.hours));
          const dayTable = document.createElement("table");
          const colgroup = document.createElement("colgroup");
          ["20%", "4%", "35%", "17.5%", "17.5%", "6%"].forEach((w) => {
            const col = document.createElement("col");
            col.style.width = w;
            colgroup.appendChild(col);
          });
          dayTable.appendChild(colgroup);
          dayTable.className = "day-table";
          const header = document.createElement("thead");
          const dayObj = parseLocal(date);
          const dateStr = dayObj.toDateString();
          header.innerHTML = `
        <tr>
            <th class="day-header" colspan="6">
                <div>
                    <div style="text-align: left;">${dateStr}</div>
                </div>
            </th>
        </tr>
        <tr class="day-header-row">
            <th style="text-align:left;">Job</th>
            <th>Hours</th>
            <th>Address</th>
            <th>Description</th>
            <th>Images</th>
            <th>Actions</th>
        </tr>`;
          dayTable.appendChild(header);
          const tbody = document.createElement("tbody");
          let offset = 0;
          if (jobs[date])
            jobs[date].forEach((job, idx) => {
              offset++;
              const row = document.createElement("tr");
              // Adjusted the image and button alignment to vertically center them and reduced image size to prevent table height increase
              if (job.locked) {
                row.innerHTML = `
<td class="day-job-${
                  offset % 2 === 0 ? "even" : "odd"
                }" style="vertical-align: middle;">${job.job}</td>
<td class="day-job-${
                  offset % 2 === 0 ? "even" : "odd"
                }" style="vertical-align: middle;">${Number(job.hours).toFixed(
                  1
                )}</td>
<td class="day-job-${
                  offset % 2 === 0 ? "even" : "odd"
                }" style="vertical-align: middle;">${job.address || ""}</td>
<td class="day-job-${
                  offset % 2 === 0 ? "even" : "odd"
                }" style="vertical-align: middle;">${job.desc}</td>
<td class="day-job-${
                  offset % 2 === 0 ? "even" : "odd"
                }" style="vertical-align: middle;">
    <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
        ${(job.images || [])
          .map(
            (img, imgIdx) =>
              `<img src="${img}" style="width: 25px; height: 25px; cursor: pointer;" onclick="openImageViewer(state.payPeriods[currentPeriod].jobs['${date}'][${idx}].images, ${imgIdx})">`
          )
          .join("")}
    </div>
</td>
<td class="day-job-${
                  offset % 2 === 0 ? "even" : "odd"
                }" style="vertical-align: middle;">
    <span class="inline-flex-gap">
        <button class="btn btn-edit no-margin" onclick="toggleEdit('${date}', ${idx}, false)">Edit</button>
        <button class="btn btn-delete no-margin" onclick="deleteJob('${date}', ${idx})">X</button>
    </span>
</td>`;
              } else {
                row.innerHTML = `
<td class="day-job-${
                  offset % 2 === 0 ? "even" : "odd"
                }" style="vertical-align: middle;"><input type="text" class="full-width-input" id="job_${date}_${idx}" value="${
                  job.job
                }" oninput="jobInputChange('${date}', ${idx})"></td>
<td class="day-job-${
                  offset % 2 === 0 ? "even" : "odd"
                }" style="vertical-align: middle;">${generateHoursDropdown(
                  `hours_${date}_${idx}`,
                  job.hours
                )}</td>
<td class="address-cell day-job-${
                  offset % 2 === 0 ? "even" : "odd"
                }" style="vertical-align: middle;">
    <input type="text" class="full-width-input" id="addr_${date}_${idx}" value="${
                  job.address || ""
                }">
    <button class="btn btn-locate" onclick="getCurrentAddress('${date}', ${idx})">üìç</button>
</td>
<td class="day-job-${
                  offset % 2 === 0 ? "even" : "odd"
                }" style="vertical-align: middle;"><input type="text" class="full-width-input" id="desc_${date}_${idx}" value="${
                  job.desc
                }"></td>
<td class="day-job-${
                  offset % 2 === 0 ? "even" : "odd"
                }" style="vertical-align: middle;">
    <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
        ${(job.images || [])
          .map(
            (img, imgIdx) =>
              `<img src="${img}" style="width: 25px; height: 25px; cursor: pointer;" onclick="openImageViewer(state.payPeriods[currentPeriod].jobs['${date}'][${idx}].images, ${imgIdx})">`
          )
          .join("")}
        <input type="file" accept="image/*" style="display: none;" id="upload_${date}_${idx}" onchange="handleImageUpload('${date}', ${idx}, event)">
        <button class="btn btn-add no-margin" onclick="document.getElementById('upload_${date}_${idx}').click()">+</button>
    </div>
</td>
<td class="day-job-${
                  offset % 2 === 0 ? "even" : "odd"
                }" style="vertical-align: middle;">
    <span class="inline-flex-gap day-job-${offset % 2 === 0 ? "even" : "odd"}">
        <button class="btn btn-check no-margin" onclick="toggleEdit('${date}', ${idx}, true)">‚úî</button>
        <button class="btn btn-delete no-margin" onclick="deleteJob('${date}', ${idx})">X</button>
    </span>
</td>`;
              }
              tbody.appendChild(row);
            });
          // Total row at the bottom with Add Job button in last cell
          const totalRow = document.createElement("tr");
          totalRow.innerHTML = `
        <td class="day-total" style="text-align:left; margin-left: 0;">Total</td>
        <td class="day-total text-center" style="text-align:center; d">${dailyTotal.toFixed(
          1
        )}</td>
        <td class="day-total text-center"></td>
        <td class="day-total text-center"></td>
        <td class="day-total text-center"></td>
        <td class="day-total text-center add-job-cell"><button class="btn btn-add" onclick="addJob('${date}')">+ Job</button></td>
        `;
          tbody.appendChild(totalRow);
          dayTable.appendChild(tbody);
          container.appendChild(dayTable);
          grandTotal += dailyTotal;
        });

        (function setupDaysManager() {
          const btn = document.getElementById("daysManagerBtn");
          const dropdown = document.getElementById("daysManagerDropdown");
          if (!btn || !dropdown) return;
          btn.onclick = function (e) {
            dropdown.style.display =
              dropdown.style.display === "block" ? "none" : "block";
            e.stopPropagation();
          };
          document.addEventListener("click", function (e) {
            if (
              dropdown.style.display === "block" &&
              !dropdown.contains(e.target) &&
              e.target !== btn
            ) {
              dropdown.style.display = "none";
            }
          });
        })();

        populatePeriodDropdown();
        restoreInputs(savedInputs);

        // After rendering day tables, add job summary table
        const jobSummaryDiv = document.getElementById("jobSummary");
        jobSummaryDiv.innerHTML = "";
        const jobTotals = {};
        allDates.forEach((date) => {
          if (jobs[date])
            jobs[date].forEach((j) => {
              const key = j.job ? j.job.trim() : "";
              if (!key) return;
              if (!jobTotals[key]) jobTotals[key] = 0;
              jobTotals[key] += Number(j.hours) || 0;
            });
        });

        const jobSummaryTitle = document.createElement("h1");
        jobSummaryTitle.textContent = "Jobs Summary";
        jobSummaryTitle.style.color = "#fff";
        jobSummaryDiv.appendChild(jobSummaryTitle);

        const summaryTable = document.createElement("table");
        summaryTable.className = "day-table";

        //   const summaryHeader = document.createElement("thead");
        //   summaryHeader.innerHTML = `
        //   <tr style="background-color: #2a3f54;">
        //     <th colspan="2" style="color: #000; width: 100%; text-align:center;">Pay Period Summary</th>
        //     </tr>
        //     `;
        // summaryTable.appendChild(summaryHeader);

        const summaryRow = document.createElement("thead");
        summaryRow.className = "summary-header-row";
        summaryRow.innerHTML = `
                <tr>
                    <th style="text-align:left;">Job</th>
                    <th>Total Hours</th>
                </tr>
                `;
        summaryTable.appendChild(summaryRow);
        const summaryBody = document.createElement("tbody");
        let summaryGrandTotal = 0;
        let offset = 0;
        Object.keys(jobTotals).forEach((job) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                  <td style="text-align:left; background-color: ${
                    offset % 2 !== 0 ? "#f2f2f2" : "#ffffff"
                  };">${job}</td>
                  <td style="text-align:center; background-color: ${
                    offset % 2 !== 0 ? "#f2f2f2" : "#ffffff"
                  };">${jobTotals[job].toFixed(1)}</td>
                `;
          summaryBody.appendChild(row);
          summaryGrandTotal += jobTotals[job];
          offset++;
        });

        // Grand total row
        const grandRow = document.createElement("tr");
        grandRow.innerHTML = `
                <td style="text-align:left; background-color: #ff9800; color: #000; font-weight: bold;">Grand Total</td>
                <td style="text-align:center; background-color: #ff9800; color: #000; font-weight: bold;">${summaryGrandTotal.toFixed(
                  1
                )}</td>
              `;

        summaryBody.appendChild(grandRow);
        summaryTable.appendChild(summaryBody);
        jobSummaryDiv.appendChild(summaryTable);
      }

      function generateHoursDropdown(id, value) {
        let options = "";
        for (let i = 0; i <= 12; i += 0.5) {
          const selected = i === value ? "selected" : "";
          options += `<option value="${i}" ${selected}>${i}</option>`;
        }
        return `<select id="${id}">${options}</select>`;
      }

      async function getCurrentAddress(date, idx) {
        if (!navigator.geolocation) {
          logMessage("Geolocation not supported", true);
          return;
        }
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          try {
            const res = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
            );
            const data = await res.json();
            const address = data.display_name || `${lat}, ${lon}`;
            document.getElementById(`addr_${date}_${idx}`).value = address;

            const jobName = document
              .getElementById(`job_${date}_${idx}`)
              .value.trim();
            if (jobName) {
              const key = jobName.toLowerCase();
              if (!state.Job_Meta[key]) state.Job_Meta[key] = {};
              state.Job_Meta[key].address = address;
            }

            logMessage("Address autofilled and saved to meta.");
            saveData();
          } catch (e) {
            logMessage("Error fetching address: " + e.message, true);
          }
        });
      }

      function jobInputChange(date, idx) {
        const jobField = document.getElementById(`job_${date}_${idx}`);
        const addrField = document.getElementById(`addr_${date}_${idx}`);
        const jobName = jobField.value.trim().toLowerCase();
        if (state.Job_Meta[jobName]) {
          addrField.value = state.Job_Meta[jobName].address || "";
        } else {
          addrField.value = "";
        }
      }

      // Updated toggleEdit to preserve the images array when saving the entry
      function toggleEdit(date, idx, lock) {
        if (lock) {
          const job = document.getElementById(`job_${date}_${idx}`).value;
          const hours =
            parseFloat(document.getElementById(`hours_${date}_${idx}`).value) ||
            0;
          const desc = document.getElementById(`desc_${date}_${idx}`).value;
          const address = document.getElementById(`addr_${date}_${idx}`).value;
          const images = state.payPeriods[currentPeriod].jobs[date][idx].images || []; // Preserve images

          state.payPeriods[currentPeriod].jobs[date][idx] = { job, hours, desc, address, images, locked: true };

          if (job) {
            const key = job.trim().toLowerCase();
            if (!state.Job_Meta[key]) state.Job_Meta[key] = {};
            if (address) state.Job_Meta[key].address = address;
          }
        } else {
          state.payPeriods[currentPeriod].jobs[date][idx].locked = false;
        }
        saveData().then(render);
      }

      function deleteJob(date, idx) {
        state.payPeriods[currentPeriod].jobs[date].splice(idx, 1);
        if (state.payPeriods[currentPeriod].jobs[date].length === 0)
          delete state.payPeriods[currentPeriod].jobs[date];
        saveData().then(render);
      }

      function addJob(date) {
        if (!state.payPeriods[currentPeriod].jobs[date])
          state.payPeriods[currentPeriod].jobs[date] = [];
        state.payPeriods[currentPeriod].jobs[date].push({
          job: "",
          hours: 0,
          desc: "",
          address: "",
          locked: false,
        });
        saveData().then(render);
      }

      function populatePeriodDropdown() {
        const dropdown = document.getElementById("payPeriodSelect");
        dropdown.innerHTML = "";
        Object.keys(state.payPeriods)
          .sort()
          .forEach((p) => {
            const opt = document.createElement("option");
            const [start, end] = p.split("_to_");
            opt.value = p;
            opt.textContent = formatPeriod(start, end);
            if (p === currentPeriod) opt.selected = true;
            dropdown.appendChild(opt);
          });
      }

      function refreshMetaPanel() {
        const metaPanel = document.getElementById("metaPanel");
        metaPanel.textContent = JSON.stringify(state.Job_Meta, null, 2);
      }

      document
        .getElementById("payPeriodSelect")
        .addEventListener("change", (e) => {
          currentPeriod = e.target.value;
          render();
        });

      // Helper to clear all onclicks
      function resetSaveButton() {
        const btn = document.getElementById("savePeriodBtn");
        const clone = btn.cloneNode(true);
        btn.parentNode.replaceChild(clone, btn);
        return document.getElementById("savePeriodBtn");
      }

      // Add Period (always adds new, never edits)
      document.getElementById("addPeriodBtn").onclick = () => {
        const container = document.getElementById("dateEditContainer");
        container.style.display = "flex";

        // Next available 14-day period (optional, set as you like)
        const today = new Date();
        const dayOfWeek = today.getDay();
        const nextWednesday = new Date(today);
        nextWednesday.setDate(today.getDate() + ((3 - dayOfWeek + 7) % 7));
        const end = new Date(nextWednesday);
        end.setDate(nextWednesday.getDate() + 13);

        document.getElementById("startDateInput").value =
          toLocalISO(nextWednesday);
        document.getElementById("endDateInput").value = toLocalISO(end);

        let saveButton = resetSaveButton();
        saveButton.textContent = "Create New Period";

        saveButton.onclick = () => {
          const start = document.getElementById("startDateInput").value;
          const end = document.getElementById("endDateInput").value;
          const newKey = `${start}_to_${end}`;
          if (!start || !end) {
            logMessage("Both start and end dates are required.", true);
            return;
          }
          if (state.payPeriods[newKey]) {
            logMessage("This period already exists.", true);
            return;
          }
          const allDates = getPayPeriodDates(newKey);
          const daysWorked = allDates.filter((dateStr) => {
            const day = parseLocal(dateStr).getDay();
            return day !== 0 && day !== 6;
          });
          state.payPeriods[newKey] = { jobs: {}, daysWorked };
          currentPeriod = newKey; // Switch to the new period
          saveData().then(() => {
            logMessage("New period added successfully.");
            container.style.display = "none";
            populatePeriodDropdown();
            render();
          });
        };
      };

      // Edit Period (only edits current, never adds new)
      document.getElementById("editPeriodBtn").onclick = () => {
        const container = document.getElementById("dateEditContainer");
        container.style.display = "flex";
        const [currentStart, currentEnd] = currentPeriod.split("_to_");
        document.getElementById("startDateInput").value = currentStart;
        document.getElementById("endDateInput").value = currentEnd;

        let saveButton = resetSaveButton();
        saveButton.textContent = "Save Period";

        saveButton.onclick = () => {
          const start = document.getElementById("startDateInput").value;
          const end = document.getElementById("endDateInput").value;
          const newKey = `${start}_to_${end}`;
          if (!start || !end) {
            logMessage("Please select valid start and end dates.", true);
            return;
          }
          if (newKey !== currentPeriod && state.payPeriods[newKey]) {
            logMessage("This period already exists.", true);
            return;
          }
          // Rename current, preserve jobs, rebuild daysWorked
          state.payPeriods[newKey] = state.payPeriods[currentPeriod];
          delete state.payPeriods[currentPeriod];
          const periodDates = getPayPeriodDates(newKey);
          state.payPeriods[newKey].daysWorked = periodDates.filter(
            (dateStr) => {
              const day = parseLocal(dateStr).getDay();
              return day !== 0 && day !== 6;
            }
          );
          currentPeriod = newKey;
          populatePeriodDropdown();
          saveData().then(() => {
            render();
            container.style.display = "none";
          });
        };
      };

      function populatePeriodCheckboxes() {
        const dropdown = document.getElementById("periodDropdown");
        dropdown.innerHTML =
          "Checked periods will remain and unchecked periods will be removed."; // Clear existing content to prevent duplicates
        Object.keys(state.payPeriods).forEach((key) => {
          const label = document.createElement("label");
          label.style.display = "block";
          label.style.marginBottom = "0px";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.value = key;
          cb.checked = true;
          label.appendChild(cb);
          label.appendChild(
            document.createTextNode(" " + formatPeriod(...key.split("_to_")))
          );
          dropdown.appendChild(label);
        });
      }

      document
        .getElementById("viewPeriodsBtn")
        .addEventListener("click", () => {
          const dropdown = document.getElementById("periodDropdown");
          if (dropdown.style.display === "none") {
            populatePeriodCheckboxes();
            dropdown.style.display = "block";
          } else {
            dropdown.style.display = "none";
          }
        });

      document.getElementById("savePeriodBtn").addEventListener("click", () => {
        const startDateInput = document.getElementById("startDateInput");
        const endDateInput = document.getElementById("endDateInput");
        const newStart = startDateInput.value;
        const newEnd = endDateInput.value;

        if (newStart && newEnd) {
          const newKey = `${newStart}_to_${newEnd}`;
          // If moving data, keep jobs, but rebuild daysWorked to fit new range
          let oldJobs = state.payPeriods[currentPeriod]?.jobs || {};
          state.payPeriods[newKey] = { jobs: oldJobs };

          // Recreate daysWorked for new range (excluding weekends)
          let periodDates = getPayPeriodDates(newKey);
          state.payPeriods[newKey].daysWorked = periodDates.filter(
            (dateStr) => {
              const day = parseLocal(dateStr).getDay();
              return day !== 0 && day !== 6; // Not Sunday or Saturday
            }
          );

          if (newKey !== currentPeriod) delete state.payPeriods[currentPeriod];
          currentPeriod = newKey;

          const dropdown = document.getElementById("periodDropdown");
          if (dropdown.style.display !== "none") {
            dropdown
              .querySelectorAll("input[type='checkbox']")
              .forEach((cb) => {
                if (!cb.checked) {
                  delete state.payPeriods[cb.value];
                }
              });
          }
          if (!state.payPeriods[currentPeriod]) {
            const remaining = Object.keys(state.payPeriods);
            currentPeriod = remaining[0] || "";
          }

          populatePeriodDropdown();

          saveData().then(() => {
            render();
            document.getElementById("dateEditContainer").style.display = "none";
            document.getElementById("periodDropdown").style.display = "none";
          });
        } else {
          logMessage("Please select valid start and end dates.", true);
        }
      });

      document
        .getElementById("generateInvoice")
        .addEventListener("click", () => {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.text(
            `Invoice for ${formatPeriod(...currentPeriod.split("_to_"))}`,
            10,
            10
          );
          const jobs = state.payPeriods[currentPeriod]?.jobs || {};
          let y = 20;
          for (const date in jobs) {
            doc.text(`${formatDate(date)}:`, 10, y);
            y += 10;
            jobs[date].forEach((j) => {
              doc.text(
                `   ${j.job} - ${j.hours}h - ${j.desc} - ${j.address}`,
                10,
                y
              );
              y += 10;
            });
          }
          doc.text(
            `Grand Total Hours: ${
              document.getElementById("grandTotal").innerText
            }`,
            10,
            y + 10
          );
          doc.save("invoice.pdf");
        });

      document.getElementById("toggleLogs").addEventListener("click", () => {
        const panel = document.getElementById("logPanel");
        const btn = document.getElementById("toggleLogs");
        if (panel.style.display === "none") {
          panel.style.display = "block";
          btn.textContent = "Hide Logs";
        } else {
          panel.style.display = "none";
          btn.textContent = "Show Logs";
        }
      });

      document.getElementById("toggleMeta").addEventListener("click", () => {
        const panel = document.getElementById("metaPanel");
        const btn = document.getElementById("toggleMeta");
        if (panel.style.display === "none") {
          refreshMetaPanel();
          panel.style.display = "block";
          btn.textContent = "Hide Meta Data";
        } else {
          panel.style.display = "none";
          btn.textContent = "Show Meta Data";
        }
      });


      // Fetch mappings bin and show login/create UI
      async function init_login() {
        // Fetch the mappings bin from JSONBin
        try {
          const res = await fetch(`https://api.jsonbin.io/v3/b/${mapping_bin_id}`, {
            headers: { "X-Master-Key": JSONBIN_KEY }
          });
          const data = await res.json();
          state.mappings = data.record || {};
        } catch (e) {
          state.mappings = {};
        }
        // Show login or create account UI
        if (!state.mappings || Object.keys(state.mappings).length === 0) {
          showCreateAccountForm();
        } else {
          document.getElementById("loginSection").style.display = "flex";
          document.getElementById("mainContent").style.display = "none";
        }
      }

      // Only call this after successful login, with bin_id
      async function init(bin_id) {
        await fetchData(bin_id);
        const [start, end] = getCurrentPeriodRange();
        const defaultKey = `${start}_to_${end}`;

        // If there are any pay periods, select the first (or whatever you prefer)
        const periodKeys = Object.keys(state.payPeriods);
        if (periodKeys.length > 0) {
          currentPeriod = periodKeys[0];
        } else {
          state.payPeriods[defaultKey] = { jobs: {} };
          currentPeriod = defaultKey;
        }

        if (!state.Job_Meta) state.Job_Meta = {};
        render();
      }

      // Run init_login on DOMContentLoaded
      window.addEventListener("DOMContentLoaded", init_login);
    </script>
  </body>
</html>
